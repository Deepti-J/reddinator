<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
<head>
    <script src="jquery-2.1.3.min.js"></script>
    <script>
            function setTheme(themeColors){
                var themeColors = themeColors.split(",");
                $("body").css("background-color", themeColors[5]);
                $("body").css("color", themeColors[0]);
                $(".comment_user").css("color", themeColors[3]);
            }

            function populateComments(json){
                var data = JSON.parse(json);
                $("#loading_view").hide();
                recursivePopulate(data);
            }

            function recursivePopulate(data){
                for (var i in data){
                    if (data[i].kind!="more"){
                        appendComment(data[i].data.parent_id, data[i].data);
                        if (data[i].data.replies!="" && data[i].data.replies.data.children!=null)
                            recursivePopulate(data[i].data.replies.data.children);
                    } else {
                        appendMoreButton(data[i].data.parent_id, data[i].data);
                    }
                }
            }

            function clearComments(){
                $("#base").html();
            }

            function loadChildComments(moreId, children){
                Reddinator.loadChildren(moreId, children);
            }

            function vote(thingId, direction){
                // determine if neutral vote
                if (direction == 1) {
                    if ($("#"+thingId+" .comment_upvote").attr("src")=="upvote_active.png") { // if already upvoted, neutralize.
                        direction = 0;
                    }
                } else { // downvote
                    if ($("#"+thingId+" .comment_downvote").attr("src")=="downvote_active.png") {
                        direction = 0;
                    }
                }

                Reddinator.vote(thingId, direction);
            }

            function voteCallback(thingId, direction){
                var upvote = $("#"+thingId).children(".comment_vote").children(".comment_upvote");
                var downvote = $("#"+thingId).children(".comment_vote").children(".comment_downvote");
                switch(direction){
                    case "-1":
                        upvote.attr("src", "upvote.png");
                        downvote.attr("src", "downvote_active.png");
                        break;
                    case "0":
                        upvote.attr("src", "upvote.png");
                        downvote.attr("src", "downvote.png");
                        break;
                    case "1":
                        upvote.attr("src", "upvote_active.png");
                        downvote.attr("src", "downvote.png");
                        break;
                }
                console.log("vote callback received: "+thingId);
            }

            function populateChildComments(moreId, json){
                var data = JSON.parse(json);
                $("#"+moreId).remove();
                for (var i in data){
                    if (data[i].kind!="more"){
                        appendComment(data[i].data.parent_id, data[i].data);
                    } else {
                        appendMoreButton(data[i].data.parent_id, data[i].data);
                    }
                    console.log(JSON.stringify(data[i]));
                }
            }

            function appendMoreButton(parentId, moreData){
                var moreElem = $("#more_template").clone().show();
                moreElem.attr("id", moreData.name);
                moreElem.children("h5").text("Load "+moreData.count+" more");
                moreElem.one('click',
                    {id: moreData.name, children: moreData.children},
                    function(event){
                        $(this).children("h5").text("Loading...");
                        loadChildComments(event.data.id, event.data.children.join(","));
                    }
                );
                if (parentId.indexOf("t3_")!==-1){
                    moreElem.appendTo("#base");
                } else {
                    moreElem.appendTo("#"+parentId+"-replies");
                }
            }

            function appendComment(parentId, commentData){
                var commentElem = $("#comment_template").clone().show();

                commentElem.attr("id", commentData.name);
                commentElem.find(".comment_replies").attr("id", commentData.name+"-replies");
                commentElem.find(".comment_text").html(htmlDecode(commentData.body_html));
                commentElem.find(".comment_user").html("/u/"+commentData.author);
                if (commentData.hasOwnProperty('likes')){
                    if (commentData.likes==1){
                        commentElem.find(".comment_upvote").attr("src", "upvote_active.png");
                    } else if (commentData.likes==-1) {
                        commentElem.find(".comment_downvote").attr("src", "downvote_active.png");
                    }
                }
                if (parentId.indexOf("t3_")!==-1){
                    commentElem.appendTo("#base");
                } else {
                    commentElem.appendTo("#"+parentId+"-replies");
                }
            }

            function htmlDecode(input){
                var e = document.createElement('div');
                e.innerHTML = input;
                return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
            }

            function toggleReplies(element){
                var replies = $(element).parent().find(".comment_replies");
                if (replies.is(":visible")){
                    replies.hide();
                    $(element).text("+");
                } else {
                    replies.show();
                    $(element).text("-");
                }
            }

            $(function(){
                //$("#comment_template").clone().show().attr("id", 'test').appendTo("#base");
                //$("#comment_template").clone().show().attr("id", 'test1').appendTo("#test .comment_replies");
                $(document).on('click', ".comment_upvote", function(){
                    vote($(this).parent().parent().attr("id"), 1);
                });
                $(document).on('click', ".comment_downvote", function(){
                    vote($(this).parent().parent().attr("id"), -1);
                });
            });

    </script>
    <style rel="stylesheet">
        body {
            margin-right:0;
        }
        .comment_box {
            border: 2px solid #D7D7D7;
            border-right: 0;
            border-radius: 4px;
            margin: 10px 0 5px 0;
            position:relative;
        }
        .more_box {
            border: 2px solid #D7D7D7;
            border-radius: 4px;
            margin-right: 6px;
        }
        .comment_text {
            padding-left:5px;
            padding-right:5px;
            margin-right: 30px;
            min-height: 50px;
        }
        .comment_replies {
            margin-left:6px;
        }
        .comment_vote {
            width: 30px;
            position: absolute;
            right: 0;
            top: 5px;
        }
        .comment_vote img {
            width: 25px;
        }
        .comment_info span {
            font-size: 16px;
            padding-left:5px;
        }
        .reply_expand {
            position: absolute;
            left:-4px;
            background-color: #D7D7D7;
            border-radius: 2px;
            width: 8px;
            height: 8px;
            font-size: 6px;
            color: black;
        }
        #loading_view {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 150px;
            margin-left:-75px;
            height: 50px;
            margin-top:-25px;
            text-align: center;
        }
        a {
            white-space: pre-wrap; /* css-3 */
            white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
            white-space: -pre-wrap; /* Opera 4-6 */
            white-space: -o-pre-wrap; /* Opera 7 */
            word-wrap: break-word; /* Internet Explorer 5.5+ */
        }
        .clearfix:after {
            clear: both;
            content: ".";
            display: block;
            height: 0;
            visibility: hidden;
        }
        .clearfix {
            display: inline-block;
        }
        .clearfix {
            display: block;
        }
    </style>
</head>
<body>
<div id="comment_template" class="comment_box" style="display: none;">
    <div class="comment_info">
        <span class="comment_user"></span>
        <span class="comment_points"></span>
        <span class="comment_reply_count"></span>
    </div>
    <div class="comment_text">
    </div>
    <div class="comment_vote">
        <img class="comment_upvote" src="upvote.png" /><br/>
        <img class="comment_downvote" src="downvote.png" />
    </div>
    <div class="clearfix"></div>
    <div class="reply_expand" onclick="toggleReplies(this);">-</div>
    <div class="comment_replies">

    </div>
</div>
<div id="more_template" class="comment_box" style="display: none; text-align:center; height:30px;">
    <h5 style="margin:0;padding:5px;">Load More</h5>
</div>
<div id="base">

</div>
<div id="loading_view">
    <h4>Loading...</h4>
</div>
</body>
</html>