<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0">
<head>
    <link href="font-awesome.min.css" rel="stylesheet">
    <script src="jquery-2.1.3.min.js"></script>
    <script>
            function setTheme(themeColors){
                var themeColors = themeColors.split(",");
                $("body").css("background-color", themeColors[5]);
                $("body").css("color", themeColors[0]);
                $(".comment_user").css("color", themeColors[3]);
                $("button").css("background-color", themeColors[3]);
            }

            function populateComments(json){
                var data = JSON.parse(json);
                $("#loading_view").hide();
                recursivePopulate(data);
            }

            function recursivePopulate(data){
                for (var i in data){
                    if (data[i].kind!="more"){
                        appendComment(data[i].data.parent_id, data[i].data);
                        if (data[i].data.replies!="" && data[i].data.replies.data.children!=null)
                            recursivePopulate(data[i].data.replies.data.children);
                    } else {
                        appendMoreButton(data[i].data.parent_id, data[i].data);
                    }
                }
            }

            function clearComments(){
                $("#base").html();
            }

            function loadChildComments(moreId, children){
                Reddinator.loadChildren(moreId, children);
            }

            function vote(thingId, direction){
                // determine if neutral vote
                if (direction == 1) {
                    if ($("#"+thingId+" .comment_upvote").attr("src")=="upvote_active.png") { // if already upvoted, neutralize.
                        direction = 0;
                    }
                } else { // downvote
                    if ($("#"+thingId+" .comment_downvote").attr("src")=="downvote_active.png") {
                        direction = 0;
                    }
                }

                Reddinator.vote(thingId, direction);
            }

            function voteCallback(thingId, direction){
                var upvote = $("#"+thingId).children(".comment_vote").children(".comment_upvote");
                var downvote = $("#"+thingId).children(".comment_vote").children(".comment_downvote");
                switch(direction){
                    case "-1":
                        upvote.attr("src", "upvote.png");
                        downvote.attr("src", "downvote_active.png");
                        break;
                    case "0":
                        upvote.attr("src", "upvote.png");
                        downvote.attr("src", "downvote.png");
                        break;
                    case "1":
                        upvote.attr("src", "upvote_active.png");
                        downvote.attr("src", "downvote.png");
                        break;
                }
                console.log("vote callback received: "+thingId);
            }

            function populateChildComments(moreId, json){
                var data = JSON.parse(json);
                $("#"+moreId).remove();
                for (var i in data){
                    if (data[i].kind!="more"){
                        appendComment(data[i].data.parent_id, data[i].data);
                    } else {
                        appendMoreButton(data[i].data.parent_id, data[i].data);
                    }
                }
            }

            function appendMoreButton(parentId, moreData){
                var moreElem = $("#more_template").clone().show();
                moreElem.attr("id", moreData.name);
                moreElem.children("h5").text("Load "+moreData.count+" more");
                moreElem.one('click',
                    {id: moreData.name, children: moreData.children},
                    function(event){
                        $(this).children("h5").text("Loading...");
                        loadChildComments(event.data.id, event.data.children.join(","));
                    }
                );
                if (parentId.indexOf("t3_")!==-1){
                    moreElem.css("margin-right", "0").appendTo("#base");
                } else {
                    moreElem.appendTo("#"+parentId+"-replies");
                }
            }

            function appendComment(parentId, commentData){
                var commentElem = $("#comment_template").clone().show();

                commentElem.attr("id", commentData.name);
                commentElem.find(".comment_replies").attr("id", commentData.name+"-replies");
                commentElem.find(".comment_text").html(htmlDecode(commentData.body_html));
                commentElem.find(".comment_user").text('/u/'+commentData.author).attr('href', 'http://www.reddit.com/u/'+commentData.author+'.compact');
                if (commentData.hasOwnProperty('likes')){
                    if (commentData.likes==1){
                        commentElem.find(".comment_upvote").attr("src", "upvote_active.png");
                    } else if (commentData.likes==-1) {
                        commentElem.find(".comment_downvote").attr("src", "downvote_active.png");
                    }
                }
                if (parentId.indexOf("t3_")!==-1){
                    commentElem.appendTo("#base");
                } else {
                    commentElem.appendTo("#"+parentId+"-replies");
                    $("#"+parentId).children('.reply_expand').show();
                }
            }

            function htmlDecode(input){
                var e = document.createElement('div');
                e.innerHTML = input;
                return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
            }

            function toggleReplies(element){
                var replies = $(element).parent().find(".comment_replies");
                if (replies.is(":visible")){
                    replies.hide();
                    $(element).children('h5').text("+");
                    $(element).children('h6').text("show replies");
                } else {
                    replies.show();
                    $(element).children('h5').text("-");
                    $(element).children('h6').text("hide replies");
                }
            }

            $(function(){
                // Layout testing code
                //$("#comment_template").clone().show().attr("id", 'test').appendTo("#base");
                //$("#comment_template").clone().show().attr("id", 'test1').appendTo("#test .comment_replies");
                $(document).on('click', ".comment_upvote", function(){
                    vote($(this).parent().parent().attr("id"), 1);
                });
                $(document).on('click', ".comment_downvote", function(){
                    vote($(this).parent().parent().attr("id"), -1);
                });
                $(document).on('click', ".post_toggle", function(){
                    var elem = $(this).parent().parent().children(".post_reply");
                    if (elem.is(":visible")){
                        elem.hide();
                    } else {
                        elem.show();
                    }
                });
                /*$(document).on('click', ".comment:not(.post_reply)", function(){
                    $(".post_reply").hide();
                });*/
            });

    </script>
    <style rel="stylesheet">
        .comment_box, .more_box, .post_box {
            border: 2px solid #D7D7D7;
            border-radius: 4px;
        }
        .comment_box {
            margin: 10px 0 5px 0;
            position: relative;
        }
        .more_box {
            margin-right: 6px;
            margin-bottom: 5px;
            text-align:center;
            height:30px;
        }
        .post_box {
            padding-right:6px;
        }
        .comment_text {
            padding-left:5px;
            padding-right:5px;
            margin-right: 30px;
            min-height: 50px;
        }
        .comment_replies {
            margin-left:6px;
            margin-right:-2px;
        }
        .comment_vote {
            width: 30px;
            position: absolute;
            right: 0;
            top: 5px;
        }
        .comment_vote img {
            width: 25px;
        }
        .comment_info span {
            font-size: 16px;
            padding-left:5px;
        }
        .reply_expand {
            display: none;
            text-align:center;
            margin-left:6px;
            margin-right:-2px;
        }
        .reply_expand h5 {
            float:left;
        }
        h5, h6 {
            margin:0;padding:5px;
        }
        .comment_options {
            text-align: right;
            padding-right: 5px;
        }
        .post_reply {
            margin-left:5px;
            margin-right:5px;
            margin-top:5px;
        }
        textarea {
            border-radius: 4px;
            width:100%;
            margin-right:4px;
        }
        button {
            border-radius: 4px;
        }
        #loading_view {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 150px;
            margin-left:-75px;
            height: 50px;
            margin-top:-25px;
            text-align: center;
        }
        a {
            white-space: pre-wrap; /* css-3 */
            white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
            white-space: -pre-wrap; /* Opera 4-6 */
            white-space: -o-pre-wrap; /* Opera 7 */
            word-wrap: break-word; /* Internet Explorer 5.5+ */
        }
        *:focus {outline:0px none transparent;}
        .clearfix:after {
            clear: both;
            content: ".";
            display: block;
            height: 0;
            visibility: hidden;
        }
        .clearfix {
            display: inline-block;
        }
        .clearfix {
            display: block;
        }
    </style>
</head>
<body>
<div id="comment_template" class="comment_box" style="display: none;">
    <div class="comment_info">
        <span><a class="comment_user" href=""></a></span>
        <span class="comment_score"></span>
        <span class="comment_reply_count"></span>
    </div>
    <div class="comment_text">
    </div>
    <div class="comment_vote">
        <img class="comment_upvote" src="upvote.png" /><br/>
        <img class="comment_downvote" src="downvote.png" />
    </div>
    <div class="clearfix"></div>
    <div class="comment_options">
        <i class="post_toggle fa fa-reply"></i>
        <i class="fa fa-cog"></i>
    </div>
    <div class="post_reply post_box" style="display:none;">
        <textarea rows="4"></textarea>
        <button onclick="postReply();">Reply</button>
    </div>
    <div class="reply_expand comment_box" onclick="toggleReplies(this);">
        <h5>-</h5>
        <h6>hide replies</h6>
    </div>
    <div class="comment_replies">

    </div>
</div>
<div id="more_template" class="more_box" style="display:none;">
    <h5>Load More</h5>
</div>
<div id="post_comment" class="post_box">
    <textarea rows="4">

    </textarea>
    <button onclick="postReply();">Comment</button>
</div>
<div id="base">

</div>
<div id="loading_view">
    <h4>Loading...</h4>
</div>
</body>
</html>